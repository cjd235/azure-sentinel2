{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('workspace'), '/(CiscoDuo')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "eTag": "*",
        "displayName": "CiscoDuo",
        "category": "Microsoft Sentinel Parser",
        "FunctionAlias": "CiscoDuo",
        "query": "CiscoDuo_CL\n| extend EventVendor = 'Cisco'\n| extend EventProduct = 'Duo Security'\n| extend parse_json(description_s)\n| extend SrcDvcType=description_s['device'],\n    SrcIpAddr=iff(isnotempty(description_s), description_s['ip_address'], access_device_ip_s),\n    DstUserName=iff(isnotempty(username_s), username_s, user_name_s),\n    SrcUserName=object_s,\n    EventType=iff(isnotempty(eventtype_s), eventtype_s, event_type_s),\n    EventEndTime=unixtime_seconds_todatetime(tolong(timestamp_d)),\n    HttpUserAgentOriginal = description_s['user_agent']\n| extend AccessDvcSecurityAgents=column_ifexists( \"access_device_security_agents_s\" , \"\")\n\t   , TrustedEndpointStatus=column_ifexists( \"trusted_endpoint_status_s\", \"\")\n\t   , SurfacedAuthAccessDeviceSecurityAgents=column_ifexists( \"surfaced_auth_access_device_security_agents_s\", \"\")\n\t   , SrcDvcOs=column_ifexists( \"access_device_os_s\", \"\")\n\t   , DstGeoRegion=column_ifexists( \"state_s\", \"\")\n\t   , AccessDvcBrowser=column_ifexists( \"access_device_browser_s\", \"\")\n\t   , AccessDvcBrowserVersion=column_ifexists( \"access_device_browser_version_s\", \"\")\n\t   , AccessDvcFlashVersion=column_ifexists( \"access_device_flash_version_s\", \"\")\n\t   , AccessDvcEncryptionEnabled=column_ifexists( \"access_device_is_encryption_enabled_s\", \"\")\n\t   , AccessDvcFirewallEnabled=column_ifexists( \"access_device_is_firewall_enabled_s\", \"\")\n\t   , AccessDvcPasswordSet=column_ifexists( \"access_device_is_password_set_s\", \"\")\n\t   , AccessDvcJavaVersion=column_ifexists( \"access_device_java_version_s\", \"\")\n\t   , AccessDvcOsVersion=column_ifexists( \"access_device_os_version_s\", \"\")\n\t   , Explanations=column_ifexists( \"explanations_s\", \"\")\n\t   , FromCommonNetblock=column_ifexists( \"from_common_netblock_b\", \"\")\n\t   , FromNewUser=column_ifexists( \"from_new_user_b\", \"\")\n\t   , SrcRiskLevel=column_ifexists( \"low_risk_ip_b\", \"\")\n\t   , PriorityEvent=column_ifexists( \"priority_event_b\", \"\")\n\t   , PriorityReasons=column_ifexists( \"priority_reasons_s\", \"\")\n\t   , Sekey=column_ifexists( \"sekey_s\", \"\")\n\t   , SurfacedAuthAccessDeviceBrowser=column_ifexists( \"surfaced_auth_access_device_browser_s\", \"\")\n\t   , SurfacedAuthAccessDeviceBrowserVersion=column_ifexists( \"surfaced_auth_access_device_browser_version_s\", \"\")\n\t   , SurfacedAuthAccessDeviceIp=column_ifexists( \"surfaced_auth_access_device_ip_s\", \"\")\n\t   , SurfacedAuthAccessDeviceEncryptionEnabled=column_ifexists( \"surfaced_auth_access_device_is_encryption_enabled_s\", \"\")\n\t   , SurfacedAuthAccessDeviceFirewallEnabled=column_ifexists( \"surfaced_auth_access_device_is_firewall_enabled_s\", \"\")\n\t   , SurfacedAuthAccessDevicePasswordSet=column_ifexists( \"surfaced_auth_access_device_is_password_set_s\", \"\")\n\t   , SurfacedAuthAccessDeviceLocationCity=column_ifexists( \"surfaced_auth_access_device_location_city_s\", \"\")\n\t   , SurfacedAuthAccessDeviceLocationCountry=column_ifexists( \"surfaced_auth_access_device_location_country_s\", \"\")\n\t   , SurfacedAuthAccessDeviceLocationState=column_ifexists( \"surfaced_auth_access_device_location_state_s\", \"\")\n\t   , SurfacedAuthAccessDeviceOs=column_ifexists( \"surfaced_auth_access_device_os_s\", \"\")\n\t   , SurfacedAuthAccessDeviceOsVersion_s=column_ifexists( \"surfaced_auth_access_device_os_version_s\", \"\")\n\t   , SurfacedAuthAlias=column_ifexists( \"surfaced_auth_alias_s\", \"\")\n\t   , SurfacedAuthApplicationKey=column_ifexists( \"surfaced_auth_application_key_s\", \"\")\n\t   , SurfacedAuthApplicationName=column_ifexists( \"surfaced_auth_application_name_s\", \"\")\n\t   , SurfacedAuthEmail=column_ifexists( \"surfaced_auth_email_s\", \"\")\n\t   , SurfacedAuthFactor=column_ifexists( \"surfaced_auth_factor_s\", \"\")\n\t   , SurfacedAuthIsotimestamp=column_ifexists( \"surfaced_auth_isotimestamp_t\", \"\")\n\t   , SurfacedAuthOodSoftware_s=column_ifexists( \"surfaced_auth_ood_software_s\", \"\")\n\t   , SurfacedAuthReason=column_ifexists( \"surfaced_auth_reason_s\", \"\")\n\t   , SurfacedAuthResult=column_ifexists( \"surfaced_auth_result_s\", \"\")\n\t   , SurfacedAuthTimestamp=column_ifexists( \"surfaced_auth_timestamp_d\", \"\")\n\t   , SurfacedAuthTransactionId=column_ifexists( \"surfaced_auth_txid_g\", \"\")\n\t   , SurfacedAuthUserGroups=column_ifexists( \"surfaced_auth_user_groups_s\", \"\")\n\t   , SurfacedAuthUserKey=column_ifexists( \"surfaced_auth_user_key_s\", \"\")\n\t   , SurfacedAuthUserName=column_ifexists( \"surfaced_auth_user_name_s\", \"\")\n\t   , SurfacedTimestamp=column_ifexists( \"surfaced_timestamp_d\", \"\")\n\t   , EventUid=column_ifexists( \"triage_event_uri_s\", \"\")\n\t   , TriagedAsInteresting=column_ifexists( \"triaged_as_interesting_b\", \"\")\n\t   , Credits=column_ifexists( \"credits_d\", \"\")\n| project-rename DvcAction=action_s,\n    DvcHostname=host_s,\n    SrcGeoCountry=access_device_location_country_s,\n    SrcGeoCity=access_device_location_city_s,\n    EventResult=result_s,\n    EventResultDetails=reason_s,\n    AuthDeviceCountry=auth_device_location_country_s,\n    AuthFactor=factor_s,\n    AccessDvcIpAddr=access_device_ip_s,\n    AccessDvcLocationState=access_device_location_state_s,\n    Alias=alias_s,\n    User=email_s,\n    SrcAppId=application_key_s,\n    SrcAppName=application_name_s,\n    DvcIpAddr=auth_device_ip_s,\n    AuthDeviceCity=auth_device_location_city_s,\n    AuthDeviceState=auth_device_location_state_s,\n    SrcHostname=auth_device_name_s,\n    TransactionId=txid_g,\n    UserGroups=user_groups_s,\n    SrcUserId=user_key_s,\n    Context=context_s,\n    IsoTimestamp=isotimestamp_t,\n    Phone=phone_s,\n    SrcDomainType=type_s\n",
        "version": 1,
        "tags": []
      }
    }
  ]
}
