{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('workspace'), '/(PaloAltoPrismaCloud')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "eTag": "*",
        "displayName": "PaloAltoPrismaCloud",
        "category": "Microsoft Sentinel Parser",
        "FunctionAlias": "PaloAltoPrismaCloud",
        "query": "let Audit_view = view () { \n    PaloAltoPrismaCloudAudit_CL\n    | extend \n        EventType='PaloAltoPrismaCloudAudit',\n        user=iff(isnotempty(column_ifexists('user_s', '')), column_ifexists('user_s', ''), column_ifexists('user_g', '')),\n        resourceName=iff(isnotempty(column_ifexists('resourceName_s', '')), column_ifexists('resourceName_s', ''), column_ifexists('resourceName_g', '')),\n        timestamp_d=column_ifexists('timestamp_d', ''),\n        IPAddress=column_ifexists('IPAddress', ''),\n        ResourceType=column_ifexists('ResourceType', ''),\n        action_s=column_ifexists('action_s', ''),\n        result_s=column_ifexists('result_s', '')\n    | project-rename  \n        UserName=user,\n        ResourceName=resourceName,\n        EventEndTime=timestamp_d,\n        SrcIpAddr=IPAddress,\n        EventMessage=action_s,\n        EventResult=result_s\n    | project-away\n        user_s,\n        resourceName_s\n};\nlet Alert_view = view () { \n    PaloAltoPrismaCloudAlert_CL\n    | extend \n        EventType='PaloAltoPrismaCloudAlert',\n        reason_s=column_ifexists('reason_s', ''),\n        policy_name_s=column_ifexists('policy_name_s', ''),\n        policy_description_s=column_ifexists('policy_description_s', ''),\n        policy_severity_s=column_ifexists('policy_severity_s', ''),\n        policy_recommendation_s=column_ifexists('policy_recommendation_s', ''),\n        policy_labels_s=column_ifexists('policy_labels_s', ''),\n        policy_lastModifiedOn_d=column_ifexists('policy_lastModifiedOn_d', ''),\n        policy_lastModifiedBy_s=column_ifexists('policy_lastModifiedBy_s', ''),\n        policy_deleted_b=column_ifexists('policy_deleted_b', ''),\n        policy_remediation_description_s=column_ifexists('policy_remediation_description_s', ''),\n        policy_remediation_impact_s=column_ifexists('policy_remediation_impact_s', ''),\n        policy_remediation_cliScriptTemplate_s=column_ifexists('policy_remediation_cliScriptTemplate_s', ''),\n        history_s=column_ifexists('history_s', ''),\n        resource_data_mfa_active_b=column_ifexists('resource_data_mfa_active_b', ''),\n        resource_data_cert_1_active_b=column_ifexists('resource_data_cert_1_active_b', ''),\n        resource_data_cert_2_active_b=column_ifexists('resource_data_cert_2_active_b', ''),\n        resource_data_password_enabled_s=column_ifexists('resource_data_password_enabled_s', ''),\n        resource_data_password_last_used_s=column_ifexists('resource_data_password_last_used_s', ''),\n        resource_data_user_creation_time_t=column_ifexists('resource_data_user_creation_time_t', ''),\n        resource_data_access_key_1_active_b=column_ifexists('resource_data_access_key_1_active_b', ''),\n        resource_data_access_key_2_active_b=column_ifexists('resource_data_access_key_2_active_b', ''),\n        resource_data_cert_1_last_rotated_s=column_ifexists('resource_data_cert_1_last_rotated_s', ''),\n        resource_data_cert_2_last_rotated_s=column_ifexists('resource_data_cert_2_last_rotated_s', ''),\n        resource_data_password_last_changed_s=column_ifexists('resource_data_password_last_changed_s', ''),\n        resource_data_password_next_rotation_s=column_ifexists('resource_data_password_next_rotation_s', ''),\n        resource_data_access_key_1_last_rotated_t=column_ifexists('resource_data_access_key_1_last_rotated_t', ''),\n        resource_data_access_key_2_last_rotated_s=column_ifexists('resource_data_access_key_2_last_rotated_s', ''),\n        resource_data_access_key_1_last_used_date_t=column_ifexists('resource_data_access_key_1_last_used_date_t', ''),\n        resource_data_access_key_2_last_used_date_s=column_ifexists('resource_data_access_key_2_last_used_date_s', ''),\n        resource_data_access_key_1_last_used_region_s=column_ifexists('resource_data_access_key_1_last_used_region_s', ''),\n        resource_data_access_key_2_last_used_region_s=column_ifexists('resource_data_access_key_2_last_used_region_s', ''),\n        resource_data_access_key_1_last_used_service_s=column_ifexists('resource_data_access_key_1_last_used_service_s', ''),\n        resource_data_access_key_2_last_used_service_s=column_ifexists('resource_data_access_key_2_last_used_service_s', ''),\n        resource_rrn_s=column_ifexists('resource_rrn_s', ''),\n        resource_name_s=column_ifexists('resource_name_s', ''),\n        resource_account_s=column_ifexists('resource_account_s', ''),\n        resource_accountId_s=column_ifexists('resource_accountId_s', ''),\n        resource_cloudAccountGroups_s=column_ifexists('resource_cloudAccountGroups_s', ''),\n        resource_region_s=column_ifexists('resource_region_s', ''),\n        resource_regionId_s=column_ifexists('resource_regionId_s', ''),\n        resource_resourceType_s=column_ifexists('resource_resourceType_s', ''),\n        resource_resourceApiName_s=column_ifexists('resource_resourceApiName_s', ''),\n        resource_url_s=column_ifexists('resource_url_s', ''),\n        resource_data_arn_s=column_ifexists('resource_data_arn_s', ''),\n        resource_data_user_s=column_ifexists('resource_data_user_s', ''),\n        resource_additionalInfo_accessKeyAge_s=column_ifexists('resource_additionalInfo_accessKeyAge_s', ''),\n        resource_additionalInfo_inactiveSinceTs_s=column_ifexists('resource_additionalInfo_inactiveSinceTs_s', ''),\n        resource_cloudType_s=column_ifexists('resource_cloudType_s', ''),\n        resource_resourceTs_d=column_ifexists('resource_resourceTs_d', ''),\n        id_s=column_ifexists('id_s', ''),\n        policy_policyId_g=column_ifexists('policy_policyId_g', ''),\n        policy_policyType_s=column_ifexists('policy_policyType_s', ''),\n        policy_systemDefault_b=column_ifexists('policy_systemDefault_b', ''),\n        policy_remediable_b=column_ifexists('policy_remediable_b', ''),\n        alertRules_s=column_ifexists('alertRules_s', ''),\n        riskDetail_riskScore_score_d=column_ifexists('riskDetail_riskScore_score_d', ''),\n        riskDetail_riskScore_maxScore_d=column_ifexists('riskDetail_riskScore_maxScore_d', ''),\n        riskDetail_rating_s=column_ifexists('riskDetail_rating_s', ''),\n        riskDetail_score_s=column_ifexists('riskDetail_score_s', ''),\n        status_s=column_ifexists('status_s', ''),\n        firstSeen_d=column_ifexists('firstSeen_d', ''),\n        lastSeen_d=column_ifexists('lastSeen_d', ''),\n        alertTime_d=column_ifexists('alertTime_d', ''),\n        resource_id=iff(isnotempty(column_ifexists('resource_id_s', '')), column_ifexists('resource_id_s', ''), column_ifexists('resource_id_g', ''))\n    | project-rename\n        Reason=reason_s,\n        AlertMessage=policy_name_s,\n        AlertDescription=policy_description_s,\n        AlertSeverity=policy_severity_s,\n        PolicyRecommendation=policy_recommendation_s,\n        PolicyLabels=policy_labels_s,\n        PolicyLastModifiedOn=policy_lastModifiedOn_d,\n        PolicyLastModifiedBy=policy_lastModifiedBy_s,\n        PolicyDeleted=policy_deleted_b,\n        PolicyRemediationDescription=policy_remediation_description_s,\n        PolicyRemediationImpact=policy_remediation_impact_s,\n        PolicyRemediationCliScriptTemplate=policy_remediation_cliScriptTemplate_s,\n        ResourceId=resource_id,\n        History=history_s,\n        ResourceDataMfaActive=resource_data_mfa_active_b,\n        ResourceDataCert1Active=resource_data_cert_1_active_b,\n        ResourceDataCert2Active=resource_data_cert_2_active_b,\n        ResourceDataPasswordEnabled=resource_data_password_enabled_s,\n        ResourceDataPasswordLastUsed=resource_data_password_last_used_s,\n        ResourceDataUserCreationTime=resource_data_user_creation_time_t,\n        ResourceDataAccessKey1Active=resource_data_access_key_1_active_b,\n        ResourceDataAccessKey2Active=resource_data_access_key_2_active_b,\n        ResourceDataCert1LastRotated=resource_data_cert_1_last_rotated_s,\n        ResourceDataCert2LastRotated=resource_data_cert_2_last_rotated_s,\n        ResourceDataPasswordLastChanged=resource_data_password_last_changed_s,\n        ResourceDataPasswordNextRotation=resource_data_password_next_rotation_s,\n        ResourceDataAccessKey1LastRotated=resource_data_access_key_1_last_rotated_t,\n        ResourceDataAccessKey2LastRotated=resource_data_access_key_2_last_rotated_s,\n        ResourceDataAccessKey1LastUsedDate=resource_data_access_key_1_last_used_date_t,\n        ResourceDataAccessKey2LastUsedDate=resource_data_access_key_2_last_used_date_s,\n        ResourceDataAccessKey1LastUsedRegion=resource_data_access_key_1_last_used_region_s,\n        ResourceDataAccessKey2LastUsedRegion=resource_data_access_key_2_last_used_region_s,\n        ResourceDataAccessKey1LastUsedService=resource_data_access_key_1_last_used_service_s,\n        ResourceDataAccessKey2LastUsedService=resource_data_access_key_2_last_used_service_s,\n        ResourceRrn=resource_rrn_s,\n        ResourceName=resource_name_s,\n        ResourceAccount=resource_account_s,\n        ResourceAccountId=resource_accountId_s,\n        ResourceCloudAccountGroups=resource_cloudAccountGroups_s,\n        ResourceRegion=resource_region_s,\n        ResourceRegionId=resource_regionId_s,\n        ResourceResourceType=resource_resourceType_s,\n        ResourceResourceApiName=resource_resourceApiName_s,\n        ResourceUrl=resource_url_s,\n        ResourceDataArn=resource_data_arn_s,\n        ResourceDataUser=resource_data_user_s,\n        ResourceAdditionalInfoAccessKeyAge=resource_additionalInfo_accessKeyAge_s,\n        ResourceAdditionalInfoInactiveSinceTs=resource_additionalInfo_inactiveSinceTs_s,\n        ResourceCloudType=resource_cloudType_s,\n        ResourceResourceTs=resource_resourceTs_d,\n        AlertId=id_s,\n        PolicyPolicyId=policy_policyId_g,\n        PolicyPolicyType=policy_policyType_s,\n        PolicySystemDefault=policy_systemDefault_b,\n        PolicyRemediable=policy_remediable_b,\n        AlertRules=alertRules_s,\n        RiskDetailRiskScoreScore=riskDetail_riskScore_score_d,\n        RiskDetailRiskScoreMaxScore=riskDetail_riskScore_maxScore_d,\n        RiskDetailRating=riskDetail_rating_s,\n        RiskDetailScore=riskDetail_score_s,\n        Status=status_s,\n        FirstSeen=firstSeen_d,\n        LastSeen=lastSeen_d,\n        AlertTime=alertTime_d\n    | project-away\n        resource_id_s\n};\nunion isfuzzy=true Alert_view, Audit_view\n",
        "version": 1,
        "tags": []
      }
    }
  ]
}
