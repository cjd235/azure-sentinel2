{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('workspace'), '/(CiscoWSAEvent')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "eTag": "*",
        "displayName": "CiscoWSAEvent",
        "category": "Microsoft Sentinel Parser",
        "FunctionAlias": "CiscoWSAEvent",
        "query": "let AllData = Syslog\n| where ProcessName =~ \"sentinel\"\n| extend LogType = iff(SyslogMessage matches regex @\"\\d{10}\\.\\d{3}\\s\\d+\\s\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\", \"Squid Logs\" , iif(SyslogMessage matches regex @\"\\d{4}\\-\\d{2}\\-\\d{2}\\s\\d{2}:\\d{2}:\\d{2}\\s\\d{10}\\.\\d{3}\", \"W3C Logs\",dynamic(\"\")))\n| extend EventVendor = 'Cisco'\n| extend EventProduct = 'Web Security Appliance'\n| extend EventType = 'Access Log';\nlet SquidLogData = AllData\n| where LogType == \"Squid Logs\"\n| parse SyslogMessage with * \" \" EventStartTimeEpoch:real \" \" Latency:int \" \" SrcIpAddr \" \" EventResultDetails \"/\" HttpStatusCode:int \" \" DstBytes:int \" \" HttpRequestMethod:string \" \" UrlOriginal:string \" \" SrcUserName:string \" \" ContactedServerCode:string \"/\" DstDvcHostname:string \" \" ResponseBodyMimeType \" \" DvcAction:string \"-\" PolicyGroupName \"-\" IdentityPolicyGroupName:string \"-\" OutboundMalwareScanningPolicyGroupName:string \"-\" DataSecurityPolicyGroupName:string \"-\" ExternalDplPolicyGroupName:string \"-\" RoutingPolicy:string \"<\" ScanningVerdictFields \">\" * \" \" * \" \" RemainingMessage\n| extend ScanningVerdictFields =  split(ScanningVerdictFields,',')\n| parse-kv RemainingMessage as (Date:string, [\"Dst-IP\"]:string, UserAgent: string, ADGroup:string, AuthMethod:string, TransID:long, TotalBytes:int, RequestBytes:int, ResponseBytes:int, ElapseTime:int) with (pair_delimiter=' ', kv_delimiter=':', quote='\"')\n| extend EventStartTime = unixtime_seconds_todatetime(todouble(EventStartTimeEpoch))\n, SuspectedUserAgent = UserAgent\n, UrlCategory = trim('\"',tostring(ScanningVerdictFields[0]))\n, WebReputationScore = tostring(ScanningVerdictFields[1])\n, MalwareScanningVerdict = tostring(ScanningVerdictFields[2])\n, ThreatName = trim('\"',tostring(ScanningVerdictFields[3]))\n, ThreatRiskRatioValue = tostring(ScanningVerdictFields[4])\n, ThreatIdentifier = tostring(ScanningVerdictFields[5])\n, TraceIdentifier = tostring(ScanningVerdictFields[6])\n, McAfeeMalwareScanningVerdict = tostring(ScanningVerdictFields[7])\n, McAfeeScannedFileName = trim('\"',tostring(ScanningVerdictFields[8]))\n, McAfeeScanError = tostring(ScanningVerdictFields[9])\n, McAfeeDetectionType = tostring(ScanningVerdictFields[10])\n, McAfeeThreatCategory = tostring(ScanningVerdictFields[11])\n, McAfeeThreatName = trim('\"',tostring(ScanningVerdictFields[12]))\n, SophosScanningVerdict = tostring(ScanningVerdictFields[13])\n, SophosScanReturnCode = tostring(ScanningVerdictFields[14])\n, SophosScannedFileName = trim('\"',tostring(ScanningVerdictFields[15]))\n, SophosThreatName = trim('\"',tostring(ScanningVerdictFields[16]))\n, CiscoDataSecurityScanningVerdict = case(tostring(ScanningVerdictFields[17]) == '0', 'Allow',\n                                     tostring(ScanningVerdictFields[17]) == '1', 'Block',\n                                     '-')\n, ExternalDlpScannningVerdict = case(tostring(ScanningVerdictFields[18]) == '0', 'Allow',\n                               tostring(ScanningVerdictFields[18]) == '1', 'Block',\n                               '-')\n, ResponseSideScanningUrlCategoryVerdict = trim('\"',tostring(ScanningVerdictFields[19]))\n, DcaUrlCategoryVerdict = tostring(ScanningVerdictFields[20])\n, ResponseThreatCategory = trim('\"',tostring(ScanningVerdictFields[21]))\n, WebReputationThreatType = trim('\"',tostring(ScanningVerdictFields[22]))\n, GteEncapsulatedUrl = trim('\"',tostring(ScanningVerdictFields[23]))\n, AvcApplicationName = trim('\"',tostring(ScanningVerdictFields[24]))\n, AvcApplicationType = trim('\"',tostring(ScanningVerdictFields[25]))\n, AvcApplicationBehavior = trim('\"',tostring(ScanningVerdictFields[26]))\n, SafeBrowsingScanningVerdict = trim('\"',tostring(ScanningVerdictFields[27]))\n, ['AvgBandwidth(Kb/sec)'] = tostring(ScanningVerdictFields[28])\n, Throttled = tostring(ScanningVerdictFields[29])\n, UserType = tostring(ScanningVerdictFields[30])\n, RequestSideAntiMalwareScanningVerdict = trim('\"',tostring(ScanningVerdictFields[31]))\n, ClientRequestThreatName = trim('\"',tostring(ScanningVerdictFields[32]))\n, AmpScanningVerdict = tostring(ScanningVerdictFields[33])\n, AmpThreatName = trim('\"',tostring(ScanningVerdictFields[34]))\n, AmpReputationScore = tostring(ScanningVerdictFields[35])\n, AmpUploadIndicator = tostring(ScanningVerdictFields[36])\n, AmpFileName = trim('\"',tostring(ScanningVerdictFields[37]))\n, AmpFileHashSha256 = trim('\"',tostring(ScanningVerdictFields[38]))\n, ArchiveScanningVerdict = tostring(ScanningVerdictFields[39])\n, ArchiveScanningVerdictDetail = tostring(ScanningVerdictFields[40])\n, ArchiveScannerFileVerdict = trim('\"',tostring(ScanningVerdictFields[41]))\n, WebTapBehavior = tostring(ScanningVerdictFields[42])\n, YouTubeUrlCategory = tostring(ScanningVerdictFields[43])\n, BlockedFileTypeDetail = tostring(ScanningVerdictFields[44]);\nlet W3CLogData = AllData\n| where LogType == \"W3C Logs\"\n| extend EventFields = split(SyslogMessage, ' ')\n| extend EventStartTime = strcat(EventFields[0], ' ', EventFields[1])\n, Latency = toint(EventFields[3])\n, SrcIpAddr = tostring(EventFields[5])\n, EventResultDetails = tostring(EventFields[6])\n, DstBytes = toint(EventFields[8])\n, HttpRequestMethod = tostring(EventFields[9])\n, UrlOriginal = tostring(EventFields[10])\n, SrcUserName = tostring(EventFields[13])\n, DstIpAddr = tostring(EventFields[11])\n, DstDvcHostname = tostring(EventFields[18])\n, ResponseBodyMimeType = tostring(EventFields[14])\n, DvcAction = tostring(EventFields[15])\n, SuspectedUserAgent = tostring(EventFields[62])\n, UrlCategory = tostring(EventFields[21])\n, McAfeeMalwareScanningVerdict = tostring(EventFields[28])\n, McAfeeScannedFileName = (EventFields[29])\n, McAfeeScanError = tostring(EventFields[30])\n, McAfeeDetectionType = tostring(EventFields[31])\n, McAfeeThreatCategory = tostring(EventFields[32])\n, McAfeeThreatName = tostring(EventFields[33])\n, SophosScanningVerdict = tostring(EventFields[34])\n, SophosScanReturnCode = tostring(EventFields[35])\n, SophosScannedFileName = tostring(EventFields[36])\n, SophosThreatName = tostring(EventFields[37])\n, CiscoDataSecurityScanningVerdict = tostring(EventFields[38])\n, ExternalDlpScannningVerdict = tostring(EventFields[39])\n, ResponseSideScanningUrlCategoryVerdict = tostring(EventFields[41])\n, AvcApplicationName = tostring(EventFields[43])\n, AvcApplicationType = tostring(EventFields[44])\n, AvcApplicationBehavior = tostring(EventFields[45])\n, SafeBrowsingScanningVerdict = tostring(EventFields[46])\n, ['AvgBandwidth(Kb/sec)'] = todouble(EventFields[47])\n, Throttled = tostring(EventFields[48])\n, UserType = tostring(EventFields[49])\n, AmpScanningVerdict = tostring(EventFields[56])\n, AmpThreatName = tostring(EventFields[57])\n, AmpReputationScore = tostring(EventFields[58])\n, AmpUploadIndicator = tostring(EventFields[59])\n, AmpFileName = tostring(EventFields[60])\n, AmpFileHashSha256 = tostring(EventFields[61])\n, HttpReferrerOriginal = tostring(EventFields[4])\n, SrcBytes = toint(EventFields[7])\n, RequestUri = tostring(EventFields[12])\n, HttpRequestXff = tostring(EventFields[16])\n, SrcPortNumber = tostring(EventFields[17])\n, DstPortNumber = tostring(EventFields[19])\n, NetworkApplicationProtocol = tostring(EventFields[20])\n, WbrsScore = tostring(EventFields[22])\n, WebrootScanningVerdict = tostring(EventFields[23])\n, WebrootThreatName = tostring(EventFields[24])\n, WebrootThreatRiskRatio = tostring(EventFields[25])\n, WebrootSpyId = tostring(EventFields[26])\n, WebrootTraceId = tostring(EventFields[27])\n, RequestSideScanningUrlCategoryVerdict = tostring(EventFields[40])\n, WebReputationThreatCategory = tostring(EventFields[42])\n, ResponseSideThreatName = tostring(EventFields[50])\n, ResponseSideThreatCategoryCode = tostring(EventFields[51])\n, ResponseSideThreatCategory = tostring(EventFields[52])\n, RequestSideDvsThreatName = tostring(EventFields[53])\n, RequestSideDvsScanningVerdict = tostring(EventFields[54])\n, RequestSideDvsVerdictName = tostring(EventFields[55])\n, NetworkBytes = toint(EventFields[63]);\nunion SquidLogData, W3CLogData\n",
        "version": 1,
        "tags": []
      }
    }
  ]
}
