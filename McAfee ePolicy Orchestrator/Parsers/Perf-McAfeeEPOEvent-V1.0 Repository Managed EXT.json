{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('workspace'), '/(McAfeeEPOEvent')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "eTag": "*",
        "displayName": "McAfeeEPOEvent",
        "category": "Microsoft Sentinel Parser",
        "FunctionAlias": "McAfeeEPOEvent",
        "query": "let mcafee_epoevent =() {\nSyslog\n| where SyslogMessage contains '<EPOevent>'\n    or ProcessName contains 'EPOEvents' //for EPO verion 5.10 at least, this is the format now\n| extend EventVendor = 'McAfee'\n| extend EventProduct = 'McAfee ePO'\n| extend DvcHostname = extract(@'\\<MachineName\\>(.*?)\\<\\/MachineName\\>', 1, SyslogMessage)\n| extend AgentGuid = extract(@'\\<AgentGUID\\>(.*?)\\<\\/AgentGUID\\>', 1, SyslogMessage)\n| extend DvcIpAddr = extract(@'\\<IPAddress\\>(.*?)\\<\\/IPAddress\\>', 1, SyslogMessage)\n| extend SrcDvcOs = extract(@'\\<OSName\\>(.*?)\\<\\/OSName\\>', 1, SyslogMessage)\n| extend DvcMacAddr = extract(@'\\<RawMACAddress\\>(.*?)\\<\\/RawMACAddress\\>', 1, SyslogMessage)\n| extend SrcUserName = extract(@'\\<UserName\\>(.*?)\\<\\/UserName\\>', 1, SyslogMessage)\n| extend TimeZoneBias = extract(@'\\<TimeZoneBias\\>(.*?)\\<\\/TimeZoneBias\\>', 1, SyslogMessage)\n| extend ProductName = extract(@'ProductName=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend ProductFamily = extract(@'ProductFamily=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend ProductVersion = extract(@'ProductVersion=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend Analyzer = extract(@'\\<Analyzer\\>(.*?)\\<\\/Analyzer\\>', 1, SyslogMessage)\n| extend AnalyzerName = extract(@'\\<AnalyzerName\\>(.*?)\\<\\/AnalyzerName\\>', 1, SyslogMessage)\n| extend AnalyzerVersion = extract(@'\\<AnalyzerVersion\\>(.*?)\\<\\/AnalyzerVersion\\>', 1, SyslogMessage)\n| extend AnalyzerHostName = extract(@'\\<AnalyzerHostName\\>(.*?)\\<\\/AnalyzerHostName\\>', 1, SyslogMessage)\n| extend AnalyzerDatVersion = extract(@'\\<AnalyzerDATVersion\\>(.*?)\\<\\/AnalyzerDATVersion\\>', 1, SyslogMessage)\n| extend AnalyzerEngineVersion = extract(@'\\<AnalyzerEngineVersion\\>(.*?)\\<\\/AnalyzerEngineVersion\\>', 1, SyslogMessage)\n| extend AnalyzerDetectionMethod = extract(@'\\<AnalyzerDetectionMethod\\>(.*?)\\<\\/AnalyzerDetectionMethod\\>', 1, SyslogMessage)\n| extend EventId = extract(@'\\<EventID\\>(.*?)\\<\\/EventID\\>', 1, SyslogMessage)\n| extend EventSeverity = extract(@'\\<Severity\\>(.*?)\\<\\/Severity\\>', 1, SyslogMessage)\n| extend EventSeverity = case(EventSeverity == 1, \"Warning\",\n                              EventSeverity == 2, \"Notice\",\n                              EventSeverity == 3, \"Alert\",\n                              EventSeverity == 4, \"Critical\",\n                              \"Information\")\n| extend GmtTime = todatetime(extract(@'\\<GMTTime\\>(.*?)\\<\\/GMTTime\\>', 1, SyslogMessage))\n| extend DetectedUtc = todatetime(extract(@'\\<DetectedUTC\\>(.*?)\\<\\/DetectedUTC\\>', 1, SyslogMessage))\n| extend ThreatName = extract(@'\\<ThreatName\\>(.*?)\\<\\/ThreatName\\>', 1, SyslogMessage)\n| extend ThreatType = extract(@'\\<ThreatType\\>(.*?)\\<\\/ThreatType\\>', 1, SyslogMessage)\n| extend ThreatCategory = extract(@'\\<ThreatCategory\\>(.*?)\\<\\/ThreatCategory\\>', 1, SyslogMessage)\n| extend ThreatId = extract(@'\\<ThreatEventID\\>(.*?)\\<\\/ThreatEventID\\>', 1, SyslogMessage)\n| extend ThreatHandled = extract(@'\\<ThreatHandled\\>(.*?)\\<\\/ThreatHandled\\>', 1, SyslogMessage)\n| extend ThreatActionTaken = extract(@'\\<ThreatActionTaken\\>(.*?)\\<\\/ThreatActionTaken\\>', 1, SyslogMessage)\n| extend ThreatSeverity = extract(@'\\<ThreatSeverity\\>(.*?)\\<\\/ThreatSeverity\\>', 1, SyslogMessage)\n| extend SrcUserUpn = extract(@'\\<SourceUserName\\>(.*?)\\<\\/SourceUserName\\>', 1, SyslogMessage)\n| extend SrcProcessName = extract(@'\\<SourceProcessName\\>(.*?)\\<\\/SourceProcessName\\>', 1, SyslogMessage)\n| extend DstDvcHostname = extract(@'\\<TargetHostName\\>(.*?)\\<\\/TargetHostName\\>', 1, SyslogMessage)\n| extend DstUserName = extract(@'\\<TargetUserName\\>(.*?)\\<\\/TargetUserName\\>', 1, SyslogMessage)\n| extend TargetProcessName = extract(@'\\<TargetProcessName\\>(.*?)\\<\\/TargetProcessName\\>', 1, SyslogMessage)\n| extend DstFileName = extract(@'\\<TargetFileName\\>(.*?)\\<\\/TargetFileName\\>', 1, SyslogMessage)\n| extend Target = extract(@'\\<CustomFields target=\\\"(.*?)\\\"\\>', 1, SyslogMessage)\n| extend BladeName = extract(@'\\<BladeName\\>(.*?)\\<\\/BladeName\\>', 1, SyslogMessage)\n| extend AnalyzerContentVersion = extract(@'\\<AnalyzerContentVersion\\>(.*?)\\<\\/AnalyzerContentVersion\\>', 1, SyslogMessage)\n| extend AnalyzerContentCreationDate = todatetime(extract(@'\\<AnalyzerContentCreationDate\\>(.*?)\\<\\/AnalyzerContentCreationDate\\>', 1, SyslogMessage))\n| extend AnalyzerRuleName = extract(@'\\<AnalyzerRuleName\\>(.*?)\\<\\/AnalyzerRuleName\\>', 1, SyslogMessage)\n| extend AnalyzerRuleId = extract(@'\\<AnalyzerRuleID\\>(.*?)\\<\\/AnalyzerRuleID\\>', 1, SyslogMessage)\n| extend AnalyzerGtiQuery = extract(@'\\<AnalyzerGTIQuery\\>(.*?)\\<\\/AnalyzerGTIQuery\\>', 1, SyslogMessage)\n| extend ThreatDetectedOnCreation = extract(@'\\<ThreatDetectedOnCreation\\>(.*?)\\<\\/ThreatDetectedOnCreation\\>', 1, SyslogMessage)\n| extend DstFileSize = extract(@'\\<TargetFileSize\\>(.*?)\\<\\/TargetFileSize\\>', 1, SyslogMessage)\n| extend DstFileModifiedTime = extract(@'\\<TargetModifyTime\\>(.*?)\\<\\/TargetModifyTime\\>', 1, SyslogMessage)\n| extend DstFileAccessedTime = extract(@'\\<TargetAccessTime\\>(.*?)\\<\\/TargetAccessTime\\>', 1, SyslogMessage)\n| extend DstFileCreationTime = extract(@'\\<TargetCreateTime\\>(.*?)\\<\\/TargetCreateTime\\>', 1, SyslogMessage)\n| extend Cleanable = extract(@'\\<Cleanable\\>(.*?)\\<\\/Cleanable\\>', 1, SyslogMessage)\n| extend TaskName = extract(@'\\<TaskName\\>(.*?)\\<\\/TaskName\\>', 1, SyslogMessage)\n| extend FirstAttemptedAction = extract(@'\\<FirstAttemptedAction\\>(.*?)\\<\\/FirstAttemptedAction\\>', 1, SyslogMessage)\n| extend FirstActionStatus = extract(@'\\<FirstActionStatus\\>(.*?)\\<\\/FirstActionStatus\\>', 1, SyslogMessage)\n| extend SecondAttemptedAction = extract(@'\\<SecondAttemptedAction\\>(.*?)\\<\\/SecondAttemptedAction\\>', 1, SyslogMessage)\n| extend SecondActionStatus = extract(@'\\<SecondActionStatus\\>(.*?)\\<\\/SecondActionStatus\\>', 1, SyslogMessage)\n| extend ApiName = extract(@'\\<APIName\\>(.*?)\\<\\/APIName\\>', 1, SyslogMessage)\n| extend SourceDescription = extract(@'\\<SourceDescription\\>(.*?)\\<\\/SourceDescription\\>', 1, SyslogMessage)\n| extend SrcProcessId = extract(@'\\<SourceProcessID\\>(.*?)\\<\\/SourceProcessID\\>', 1, SyslogMessage)\n| extend SrcProcessHashMd5 = extract(@'\\<SourceProcessHash\\>([a-fA-F0-9]{32})\\<', 1, SyslogMessage)\n| extend AttackVectorType = extract(@'\\<AttackVectorType\\>(.*?)\\<\\/AttackVectorType\\>', 1, SyslogMessage)\n| extend DurationBeforeDetection = extract(@'\\<DurationBeforeDetection\\>(.*?)\\<\\/DurationBeforeDetection\\>', 1, SyslogMessage)\n| extend NaturalLangDescription = extract(@'\\<NaturalLangDescription\\>(.*?)\\<\\/NaturalLangDescription\\>', 1, SyslogMessage)\n| extend AccessRequested = extract(@'\\<AccessRequested\\>(.*?)\\</\\AccessRequested\\>', 1, SyslogMessage)\n| extend DetectionMessage = extract(@'\\<DetectionMessage\\>(.*?)\\</\\DetectionMessage\\>', 1, SyslogMessage)\n| extend AmCoreContentVersion = extract(@'\\<AMCoreContentVersion\\>(.*?)\\</\\AMCoreContentVersion\\>', 1, SyslogMessage)\n| extend SrcIpAddr = extract(@'\\<SourceIPV4\\>(.*?)\\<\\/SourceIPV4\\>', 1, SyslogMessage)\n| extend SrcMacAddr = extract(@'\\<SourceMAC\\>(.*?)\\<\\/SourceMAC\\>', 1, SyslogMessage)\n| extend DstIpAddr = extract(@'\\<TargetIPV4\\>(.*?)\\<\\/TargetIPV4\\>', 1, SyslogMessage)\n| extend DstMacAddr = extract(@'\\<TargetMAC\\>(.*?)\\<\\/TargetMAC\\>', 1, SyslogMessage)\n};\nlet mcafee_updateevent =() {\nSyslog\n| where SyslogMessage contains '<UpdateEvents>'\n| extend EventVendor = 'McAfee'\n| extend EventProduct = 'McAfee ePO'\n| extend AgentGuid = extract(@'\\<AgentGUID\\>(.*?)\\<\\/AgentGUID\\>', 1, SyslogMessage)\n| extend DvcHostname = extract(@'\\<MachineName\\>(.*?)\\<\\/MachineName\\>', 1, SyslogMessage)\n| extend DvcMacAddr = extract(@'\\<RawMACAddress\\>(.*?)\\<\\/RawMACAddress\\>', 1, SyslogMessage)\n| extend DvcIpAddr = extract(@'\\<IPAddress\\>(.*?)\\<\\/IPAddress\\>', 1, SyslogMessage)\n| extend AgentVersion = extract(@'\\<AgentVersion\\>(.*?)\\<\\/AgentVersion\\>', 1, SyslogMessage)\n| extend SrcUserName = extract(@'\\<UserName\\>(.*?)\\<\\/UserName\\>', 1, SyslogMessage)\n| extend TimeZoneBias = extract(@'\\<TimeZoneBias\\>(.*?)\\<\\/TimeZoneBias\\>', 1, SyslogMessage)\n| extend ProductName = extract(@'ProductName=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend ProductFamily = extract(@'ProductFamily=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend ProductVersion = extract(@'ProductVersion=\\\"(.*?)\\\"', 1, SyslogMessage)\n| extend EventId = extract(@'\\<EventID\\>(.*?)\\<\\/EventID\\>', 1, SyslogMessage)\n| extend EventSeverity = extract(@'\\<Severity\\>(.*?)\\<\\/Severity\\>', 1, SyslogMessage)\n| extend EventSeverity = case(EventSeverity == 1, \"Warning\",\n                              EventSeverity == 2, \"Notice\",\n                              EventSeverity == 3, \"Alert\",\n                              EventSeverity == 4, \"Critical\",\n                              \"Information\")\n| extend GmtTime = todatetime(extract(@'\\<GMTTime\\>(.*?)\\<\\/GMTTime\\>', 1, SyslogMessage))\n| extend ProductId = extract(@'\\<ProductID\\>(.*?)\\<\\/ProductID\\>', 1, SyslogMessage)\n| extend Locale = extract(@'\\<Locale\\>(.*?)\\<\\/Locale\\>', 1, SyslogMessage)\n| extend Error = extract(@'\\<Error\\>(.*?)\\<\\/Error\\>', 1, SyslogMessage)\n| extend Type = extract(@'\\<Type\\>(.*?)\\<\\/Type\\>', 1, SyslogMessage)\n| extend Version = extract(@'\\<Version\\>(.*?)\\<\\/Version\\>', 1, SyslogMessage)\n| extend InitiatorId = extract(@'\\<InitiatorID\\>(.*?)\\<\\/InitiatorID\\>', 1, SyslogMessage)\n| extend InitiatorType = extract(@'\\<InitiatorType\\>(.*?)\\<\\/InitiatorType\\>', 1, SyslogMessage)\n| extend SiteName = extract(@'\\<SiteName\\>(.*?)\\<\\/SiteName\\>', 1, SyslogMessage)\n| extend Description = extract(@'\\<Description\\>(.*?)\\<\\/Description\\>', 1, SyslogMessage)\n};\nunion isfuzzy=true mcafee_epoevent, mcafee_updateevent\n| project TimeGenerated\n        , GmtTime\n        , EventVendor\n        , EventProduct\n        , EventId\n        , EventSeverity\n        , AgentGuid\n        , DvcHostname\n        , DvcIpAddr\n        , DvcMacAddr\n        , AgentVersion\n        , SrcDvcOs\n        , SrcUserName\n        , TimeZoneBias\n        , ProductName\n        , ProductFamily\n        , ProductVersion\n        , Analyzer\n        , AnalyzerName\n        , AnalyzerVersion\n        , AnalyzerHostName\n        , AnalyzerDatVersion\n        , AnalyzerEngineVersion\n        , AnalyzerDetectionMethod\n        , ThreatName\n        , ThreatType\n        , ThreatCategory\n        , ThreatId\n        , ThreatHandled\n        , ThreatActionTaken\n        , ThreatSeverity\n        , SrcUserUpn\n        , SrcProcessName\n        , DstDvcHostname\n        , DstUserName\n        , TargetProcessName\n        , DstFileName\n        , Target\n        , BladeName\n        , AnalyzerContentVersion\n        , AnalyzerContentCreationDate\n        , AnalyzerRuleName\n        , AnalyzerRuleId\n        , AnalyzerGtiQuery\n        , ThreatDetectedOnCreation\n        , DstFileSize\n        , DstFileModifiedTime\n        , DstFileAccessedTime\n        , DstFileCreationTime\n        , Cleanable\n        , TaskName\n        , FirstAttemptedAction\n        , FirstActionStatus\n        , SecondAttemptedAction\n        , SecondActionStatus\n        , ApiName\n        , SourceDescription\n        , SrcProcessId\n        , SrcProcessHashMd5\n        , AttackVectorType\n        , DurationBeforeDetection\n        , AccessRequested\n        , DetectionMessage\n        , AmCoreContentVersion\n        , SrcIpAddr\n        , SrcMacAddr\n        , DstIpAddr\n        , DstMacAddr\n        , ProductId\n        , Locale\n        , Error\n        , Type\n        , Version\n        , InitiatorId\n        , InitiatorType\n        , SiteName\n        , Description\n",
        "version": 1,
        "tags": []
      }
    }
  ]
}
