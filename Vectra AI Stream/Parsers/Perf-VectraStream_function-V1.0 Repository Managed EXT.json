{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workspace": {
      "type": "String"
    }
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/savedSearches",
      "apiVersion": "2020-08-01",
      "name": "[concat(parameters('workspace'), '/(VectraStream_function')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "eTag": "*",
        "displayName": "VectraStream_function",
        "category": "Microsoft Sentinel Parser",
        "FunctionAlias": "VectraStream_function",
        "query": "VectraStream_CL\n| extend\n    EventVendor=\"Vectra AI\",\n    EventProduct=\"Vectra Stream\",\n    EventEndTime=column_ifexists('ts_d', ''),\n    metadata_type_s = column_ifexists('metadata_type_s', ''),\n    community_id_s = column_ifexists('community_id_s', ''),\n    id_ip_ver_s = column_ifexists('id_ip_ver_s', ''),\n    id_orig_h_s = column_ifexists('id_orig_h_s', ''),\n    id_orig_p_d = column_ifexists('id_orig_p_d', ''),\n    id_resp_h_s = column_ifexists('id_resp_h_s', ''),\n    id_resp_p_d = column_ifexists('id_resp_p_d', ''),\n    resp_hostname_s = column_ifexists('resp_hostname_s', ''),\n    local_orig_b = column_ifexists('local_orig_b', ''),\n    local_resp_b = column_ifexists('local_resp_b', ''),\n    orig_huid_s = column_ifexists('orig_huid_s', ''),\n    orig_hostname_s = column_ifexists('orig_hostname_s', ''),\n    orig_sluid_s = column_ifexists('orig_sluid_s', ''),\n    resp_huid_s = column_ifexists('resp_huid_s', ''),\n    resp_sluid_s = column_ifexists('resp_sluid_s', ''),\n    sensor_uid_s = column_ifexists('sensor_uid_s', ''),\n    uid_s = column_ifexists('uid_s', ''),\n    ts_d = column_ifexists('ts_d', ''),\n    error_s = column_ifexists('error_s', ''),\n\tconn_state_s = column_ifexists('conn_state_s', ''),\n    duration_d = column_ifexists('duration_d', ''),\n    service_s = column_ifexists('service_s', ''),\n    proto_d = column_ifexists('proto_d', ''),\n    protoName_s = column_ifexists('protoName_s', ''),\n    orig_ip_bytes_d = column_ifexists('orig_ip_bytes_d', ''),\n    resp_ip_bytes_d = column_ifexists('resp_ip_bytes_d', ''),\n    orig_pkts_d = column_ifexists('orig_pkts_d', ''),\n    resp_pkts_d = column_ifexists('resp_pkts_d', ''),\n    session_start_time_d = column_ifexists('session_start_time_d', ''),\n    resp_domain_s = column_ifexists('resp_domain_s', ''),\n    orig_vlan_id_d = column_ifexists('orig_vlan_id_d', ''),\n    resp_vlan_id_d = column_ifexists('resp_vlan_id_d', ''),\n    first_orig_resp_data_pkt_s = column_ifexists('first_orig_resp_data_pkt_s', ''),\n    first_resp_orig_data_pkt_s = column_ifexists('first_resp_orig_data_pkt_s', ''),\n    first_orig_resp_data_pkt_time_d = column_ifexists('first_orig_resp_data_pkt_time_d', ''),\n    first_resp_orig_data_pkt_time_d = column_ifexists('first_resp_orig_data_pkt_time_d', ''),\n    first_orig_resp_pkt_time_d = column_ifexists('first_orig_resp_pkt_time_d', ''),\n    first_resp_orig_pkt_time_d = column_ifexists('first_resp_orig_pkt_time_d', ''),\n    resp_multihomed_b = column_ifexists('resp_multihomed_b', ''),\n    dir_confidence_d = column_ifexists('dir_confidence_d', ''),\n    //beacon specific attributes\n\tbeacon_type_s = column_ifexists('beacon_type_s', ''),\n    beacon_uid_s = column_ifexists('beacon_uid_s', ''),\n    first_event_time_d = column_ifexists('first_event_time_d', ''),\n    last_event_time_d = column_ifexists('last_event_time_d', ''),\n    resp_domains_s = column_ifexists('resp_domains_s', ''),\n    session_count_d = column_ifexists('session_count_d', ''),\n    //dcerpc\n\trtt_s = column_ifexists('rtt_s', ''),\n    endpoint_s = column_ifexists('endpoint_s', ''),\n    username_s = column_ifexists('username_s', ''),\n    hostname_s = column_ifexists('hostname_s', ''),\n    domain_s = column_ifexists('domain_s', ''),\n    operation_s = column_ifexists('operation_s', ''),\n\t//dhcp\n    mac_s = column_ifexists('mac_s', ''),\n    assigned_ip_s = column_ifexists('assigned_ip_s', ''),\n    lease_time_d = column_ifexists('lease_time_d', ''),\n    trans_id_s = column_ifexists('trans_id_s', ''),\n    dhcp_server_ip_s = column_ifexists('dhcp_server_ip_s', ''),\n    dns_server_ips_s = column_ifexists('dns_server_ips_s', ''),\n\t//dns\n    trans_id_d = column_ifexists('trans_id_d', ''),\n    query_s = column_ifexists('query_s', ''),\n    qclass_d = column_ifexists('qclass_d', ''),\n    qclass_name_s = column_ifexists('qclass_name_s', ''),\n    qtype_d = column_ifexists('qtype_d', ''),\n    qtype_name_s = column_ifexists('qtype_name_s', ''),\n    rcode_d = column_ifexists('rcode_d', ''),\n    rcode_name_s = column_ifexists('rcode_name_s', ''),\n    AA_b = column_ifexists('AA_b', ''),\n    TC_b = column_ifexists('TC_b', ''),\n    RD_b = column_ifexists('RD_b', ''),\n    RA_b = column_ifexists('RA_b', ''),\n    answers_s = column_ifexists('answers_s', ''),\n    TTLs_s = column_ifexists('TTLs_s', ''),\n    auth_s = column_ifexists('auth_s', ''),\n    total_answers_d = column_ifexists('total_answers_d', ''),\n    total_replies_d = column_ifexists('total_replies_d', ''),\n    rejected_b = column_ifexists('rejected_b', ''),\n    saw_query_b = column_ifexists('saw_query_b', ''),\n    saw_reply_b = column_ifexists('saw_reply_b', ''),\n    values_s = column_ifexists('values_s', ''),\n\t//http\n    method_s = column_ifexists('method_s', ''),\n    host_s = column_ifexists('host_s', ''),\n    uri_s = column_ifexists('uri_s', ''),\n    referrer_s = column_ifexists('referrer_s', ''),\n    user_agent_s = column_ifexists('user_agent_s', ''),\n    request_body_len_d = column_ifexists('request_body_len_d', ''),\n    response_body_len_d = column_ifexists('response_body_len_d', ''),\n    orig_mime_types_s = column_ifexists('orig_mime_types_s', ''),\n    resp_mime_types_s = column_ifexists('resp_mime_types_s', ''),\n    status_code_d = column_ifexists('status_code_d', ''),\n    status_msg_s = column_ifexists('status_msg_s', ''),\n    proxied_s = column_ifexists('proxied_s', ''),\n    cookie_s = column_ifexists('cookie_s', ''),\n    cookie_vars_s = column_ifexists('cookie_vars_s', ''),\n    request_cache_control_s = column_ifexists('request_cache_control_s', ''),\n    response_cache_control_s = column_ifexists('response_cache_control_s', ''),\n    response_expires_s = column_ifexists('response_expires_s', ''),\n    request_header_count_d = column_ifexists('request_header_count_d', ''),\n    response_header_count_d = column_ifexists('response_header_count_d', ''),\n    is_proxied_b = column_ifexists('is_proxied_b', ''),\n    host_multihomed_b = column_ifexists('host_multihomed_b', ''),\n    resp_filename_s = column_ifexists('resp_filename_s', ''),\n    response_content_disposition_s = column_ifexists('response_content_disposition_s', ''),\n\t//Kerberos\n    client_s = column_ifexists('client_s', ''),\n    data_source_s = column_ifexists('data_source_s', ''),\n    success_b = column_ifexists('success_b', ''),\n    error_code_s = column_ifexists('error_code_s', ''),\n    error_msg_s = column_ifexists('error_msg_s', ''),\n    request_type_s = column_ifexists('request_type_s', ''),\n    protocol_s = column_ifexists('protocol_s', ''),\n    reply_timestamp_d = column_ifexists('reply_timestamp_d', ''),\n    orig_host_observed_privilege_d = column_ifexists('orig_host_observed_privilege_d', ''),\n    req_ciphers_s = column_ifexists('req_ciphers_s', ''),\n    rep_cipher_s = column_ifexists('rep_cipher_s', ''),\n    //ldap\n    message_id_d = column_ifexists('message_id_d', ''),\n    base_object_s = column_ifexists('base_object_s', ''),\n    query_scope_s = column_ifexists('query_scope_s', ''),\n    result_s = column_ifexists('result_s', ''),\n    matched_dn_s = column_ifexists('matched_dn_s', ''),\n    attributes_s = column_ifexists('attributes_s', ''),\n    bind_error_count_d = column_ifexists('bind_error_count_d', ''),\n    encrypted_sasl_payload_count_d = column_ifexists('encrypted_sasl_payload_count_d', ''),\n    logon_failure_error_count_s = column_ifexists('logon_failure_error_count_s', ''),\n    response_bytes_s = column_ifexists('response_bytes_s', ''),\n    request_bytes_s = column_ifexists('request_bytes_s', ''),\n    result_code_s = column_ifexists('result_code_s', ''),\n    result_count_d = column_ifexists('result_count_d', ''),\n    is_query_b = column_ifexists('is_query_b', ''),\n    is_close_b = column_ifexists('is_close_b', ''),\n\t//ntlm\n    status_d = column_ifexists('status_d', ''),\n\t//rdp\n    keyboard_layout_s = column_ifexists('keyboard_layout_s', ''),\n    client_build_s = column_ifexists('client_build_s', ''),\n    date_s = column_ifexists('date_s', ''),\n    client_dig_protocol_id_d = column_ifexists('client_dig_protocol_id_d', ''),\n    client_dig_product_id_d = column_ifexists('client_dig_product_id_d', ''),\n    client_name_s = column_ifexists('client_name_s', ''),\n    desktop_width_d = column_ifexists('desktop_width_d', ''),\n    desktop_height_d = column_ifexists('desktop_height_d', ''),\n\t//smbfiles\n    action_s = column_ifexists('action_s', ''),\n    delete_on_close_b = column_ifexists('delete_on_close_b', ''),\n    path_s = column_ifexists('path_s', ''),\n    name_s = column_ifexists('name_s', ''),\n    prev_name_s = column_ifexists('prev_name_s', ''),\n    version_s = column_ifexists('version_s', ''),\n\t//smtp\n    helo_s = column_ifexists('helo_s', ''),\n    mail_from_s = column_ifexists('mail_from_s', ''),\n    rcpt_to_s = column_ifexists('rcpt_to_s', ''),\n    date_d = column_ifexists('date_d', ''),\n    from_s = column_ifexists('from_s', ''),\n    to_s = column_ifexists('to_s', ''),\n    cc_s = column_ifexists('cc_s', ''),\n    reply_to_s = column_ifexists('reply_to_s', ''),\n    msgid_d = column_ifexists('msgid_d', ''),\n    in_reply_to_s = column_ifexists('in_reply_to_s', ''),\n    subject_s = column_ifexists('subject_s', ''),\n    x_originating_ip_s = column_ifexists('x_originating_ip_s', ''),\n    first_received_s = column_ifexists('first_received_s', ''),\n    second_received_s = column_ifexists('second_received_s', ''),\n    useragent_s = column_ifexists('useragent_s', ''),\n    tls_s = column_ifexists('tls_s', ''),\n    spf_helo_s = column_ifexists('spf_helo_s', ''),\n    spf_mailfrom_s = column_ifexists('spf_mailfrom_s', ''),\n    dkim_status_s = column_ifexists('dkim_status_s', ''),\n    dmarc_status_s = column_ifexists('dmarc_status_s', ''),\n\t//ssh\n    server_s = column_ifexists('server_s', ''),\n    cipher_alg_s = column_ifexists('cipher_alg_s', ''),\n    mac_alg_s = column_ifexists('mac_alg_s', ''),\n    compression_alg_s = column_ifexists('compression_alg_s', ''),\n    kex_alg_s = column_ifexists('kex_alg_s', ''),\n    host_key_alg_s = column_ifexists('host_key_alg_s', ''),\n    host_key_s = column_ifexists('host_key_s', ''),\n    hassh_g = column_ifexists('hassh_g', ''),\n    hasshServer_g = column_ifexists('hasshServer_g', ''),\n\t//ssl\n    server_name_s = column_ifexists('server_name_s', ''),\n    established_b = column_ifexists('established_b', ''),\n    next_protocol_s = column_ifexists('next_protocol_s', ''),\n    cipher_s = column_ifexists('cipher_s', ''),\n    version_num_d = column_ifexists('version_num_d', ''),\n    curve_s = column_ifexists('curve_s', ''),\n    issuer_s = column_ifexists('issuer_s', ''),\n    client_issuer_s = column_ifexists('client_issuer_s', ''),\n    client_subject_s = column_ifexists('client_subject_s', ''),\n    client_version_num_d = column_ifexists('client_version_num_d', ''),\n    client_version_s = column_ifexists('client_version_s', ''),\n    client_extension_s = column_ifexists('client_extension_s', ''),\n    client_ec_point_format_s = column_ifexists('client_ec_point_format_s', ''),\n    client_curve_num_s = column_ifexists('client_curve_num_s', ''),\n    ja3_g = column_ifexists('ja3_g', ''),\n    ja3s_g = column_ifexists('ja3s_g', ''),\n    server_extensions_s = column_ifexists('server_extensions_s', ''),\n\t//x509\n    certificate_version_d = column_ifexists('certificate_version_d', ''),\n    certificate_serial_s = column_ifexists('certificate_serial_s', ''),\n    certificate_serial_g = column_ifexists('certificate_serial_g', ''),\n    certificate_subject_s = column_ifexists('certificate_subject_s', ''),\n    certificate_issuer_s = column_ifexists('certificate_issuer_s', ''),\n    certificate_key_alg_s = column_ifexists('certificate_key_alg_s', ''),\n    certificate_key_length_s = column_ifexists('certificate_key_length_s', ''),\n    certificate_key_type_s = column_ifexists('certificate_key_type_s', ''),\n    certificate_not_valid_after_d = column_ifexists('certificate_not_valid_after_d', ''),\n    certificate_not_valid_before_d = column_ifexists('certificate_not_valid_before_d', ''),\n    certificate_exponent_s = column_ifexists('certificate_exponent_s', ''),\n    certificate_sig_alg_s = column_ifexists('certificate_sig_alg_s', ''),\n    certificate_self_issued_b = column_ifexists('certificate_self_issued_b', ''),\n    certificate_curve_s = column_ifexists('certificate_curve_s', ''),\n    certificate_cn_s = column_ifexists('certificate_cn_s', ''),\n    san_dns_s = column_ifexists('san_dns_s', ''),\n    san_email_s = column_ifexists('san_email_s', ''),\n    san_ip_s = column_ifexists('san_ip_s', ''),\n    san_other_fields_b = column_ifexists('san_other_fields_b', ''),\n    basic_constraints_ca_b = column_ifexists('basic_constraints_ca_b', ''),\n    basic_constraints_path_len_d = column_ifexists('basic_constraints_path_len_d', ''),\n    certificate_serial = case(isnotempty(certificate_serial_s), certificate_serial_s, isnotempty(certificate_serial_g), certificate_serial_g, '')\n| project-rename\n    metadata_type = metadata_type_s,\n    community_id = community_id_s,\n    id_ip_ver = id_ip_ver_s,\n    id_orig_h = id_orig_h_s,\n    id_orig_p = id_orig_p_d,\n    id_resp_h = id_resp_h_s,\n    id_resp_p = id_resp_p_d,\n    resp_hostname = resp_hostname_s,\n    local_orig = local_orig_b,\n    local_resp = local_resp_b,\n    orig_huid = orig_huid_s,\n    orig_hostname = orig_hostname_s,\n    orig_sluid = orig_sluid_s,\n    resp_huid = resp_huid_s,\n    resp_sluid = resp_sluid_s,\n    sensor_uid = sensor_uid_s,\n    uid = uid_s,\n    ts = ts_d,\n    error = error_s,\n\tconn_state = conn_state_s,\n    duration = duration_d,\n    service = service_s,\n    proto = proto_d,\n    protoName = protoName_s,\n    orig_ip_bytes = orig_ip_bytes_d,\n    resp_ip_bytes = resp_ip_bytes_d,\n    orig_pkts = orig_pkts_d,\n    resp_pkts = resp_pkts_d,\n    session_start_time = session_start_time_d,\n    resp_domain = resp_domain_s,\n    orig_vlan_id = orig_vlan_id_d,\n    resp_vlan_id = resp_vlan_id_d,\n    first_orig_resp_data_pkt = first_orig_resp_data_pkt_s,\n    first_resp_orig_data_pkt = first_resp_orig_data_pkt_s,\n    first_orig_resp_data_pkt_time = first_orig_resp_data_pkt_time_d,\n    first_resp_orig_data_pkt_time = first_resp_orig_data_pkt_time_d,\n    first_orig_resp_pkt_time = first_orig_resp_pkt_time_d,\n    first_resp_orig_pkt_time = first_resp_orig_pkt_time_d,\n    resp_multihomed = resp_multihomed_b,\n    dir_confidence = dir_confidence_d,\n    //beacon specific attributes\n\tbeacon_type = beacon_type_s,\n    beacon_uid = beacon_uid_s,\n    first_event_time = first_event_time_d,\n    last_event_time = last_event_time_d,\n    resp_domains = resp_domains_s,\n    session_count = session_count_d,\n    //dcerpc\n\trtt = rtt_s,\n    endpoint = endpoint_s,\n    username = username_s,\n    hostname = hostname_s,\n    domain = domain_s,\n    operation = operation_s,\n\t//dhcp\n    mac = mac_s,\n    assigned_ip = assigned_ip_s,\n    lease_time = lease_time_d,\n    dhcp_server_ip = dhcp_server_ip_s,\n    dns_server_ips = dns_server_ips_s,\n\t//dns\n    trans_id = trans_id_d,\n    query = query_s,\n    qclass = qclass_d,\n    qclass_name = qclass_name_s,\n    qtype = qtype_d,\n    qtype_name = qtype_name_s,\n    rcode = rcode_d,\n    rcode_name = rcode_name_s,\n    AA = AA_b,\n    TC = TC_b,\n    RD = RD_b,\n    RA = RA_b,\n    answers = answers_s,\n    TTLs = TTLs_s,\n    auth = auth_s,\n    total_answers = total_answers_d,\n    total_replies = total_replies_d,\n    rejected = rejected_b,\n    saw_query = saw_query_b,\n    saw_reply = saw_reply_b,\n    values = values_s,\n\t//http\n    method = method_s,\n    host = host_s,\n    uri = uri_s,\n    referrer = referrer_s,\n    user_agent = user_agent_s,\n    request_body_len = request_body_len_d,\n    response_body_len = response_body_len_d,\n    orig_mime_types = orig_mime_types_s,\n    resp_mime_types = resp_mime_types_s,\n    status_code = status_code_d,\n    status_msg = status_msg_s,\n    proxied = proxied_s,\n    cookie = cookie_s,\n    cookie_vars = cookie_vars_s,\n    request_cache_control = request_cache_control_s,\n    response_cache_control = response_cache_control_s,\n    response_expires = response_expires_s,\n    request_header_count = request_header_count_d,\n    response_header_count = response_header_count_d,\n    is_proxied = is_proxied_b,\n    host_multihomed = host_multihomed_b,\n    resp_filename = resp_filename_s,\n    response_content_disposition = response_content_disposition_s,\n\t//Kerberos\n    client = client_s,\n    data_source = data_source_s,\n    success = success_b,\n    error_code = error_code_s,\n    error_msg = error_msg_s,\n    request_type = request_type_s,\n    protocol = protocol_s,\n    reply_timestamp = reply_timestamp_d,\n    orig_host_observed_privilege = orig_host_observed_privilege_d,\n    req_ciphers = req_ciphers_s,\n    rep_cipher = rep_cipher_s,\n    //ldap\n    message_id = message_id_d,\n    base_object = base_object_s,\n    query_scope = query_scope_s,\n    result = result_s,\n    matched_dn = matched_dn_s,\n    attributes = attributes_s,\n    bind_error_count = bind_error_count_d,\n    encrypted_sasl_payload_count = encrypted_sasl_payload_count_d,\n    logon_failure_error_count = logon_failure_error_count_s,\n    response_bytes = response_bytes_s,\n    request_bytes = request_bytes_s,\n    result_code = result_code_s,\n    result_count = result_count_d,\n    is_query = is_query_b,\n    is_close = is_close_b,\n\t//ntlm\n    status = status_d,\n\t//rdp\n    keyboard_layout = keyboard_layout_s,\n    client_build = client_build_s,\n    client_dig_protocol_id = client_dig_protocol_id_d,\n    client_dig_product_id = client_dig_product_id_d,\n    client_name = client_name_s,\n    desktop_width = desktop_width_d,\n    desktop_height = desktop_height_d,\n\t//smbfiles\n    action = action_s,\n    delete_on_close = delete_on_close_b,\n    path = path_s,\n    name = name_s,\n    prev_name = prev_name_s,\n    version = version_s,\n\t//smtp\n    helo = helo_s,\n    mail_from = mail_from_s,\n    rcpt_to = rcpt_to_s,\n    date_msg = date_d,\n    from = from_s,\n    to_msg = to_s,\n    cc = cc_s,\n    reply_to = reply_to_s,\n    msgid = msgid_d,\n    in_reply_to = in_reply_to_s,\n    subject = subject_s,\n    x_originating_ip = x_originating_ip_s,\n    first_received = first_received_s,\n    second_received = second_received_s,\n    useragent = useragent_s,\n    tls = tls_s,\n    spf_helo = spf_helo_s,\n    spf_mailfrom = spf_mailfrom_s,\n    dkim_status = dkim_status_s,\n    dmarc_status = dmarc_status_s,\n\t//ssh\n    server = server_s,\n    cipher_alg = cipher_alg_s,\n    mac_alg = mac_alg_s,\n    compression_alg = compression_alg_s,\n    kex_alg = kex_alg_s,\n    host_key_alg = host_key_alg_s,\n    host_key = host_key_s,\n    hassh = hassh_g,\n    hasshServer = hasshServer_g,\n\t//ssl\n    server_name = server_name_s,\n    established = established_b,\n    next_protocol = next_protocol_s,\n    cipher = cipher_s,\n    version_num = version_num_d,\n    curve = curve_s,\n    issuer = issuer_s,\n    client_issuer = client_issuer_s,\n    client_subject = client_subject_s,\n    client_version_num = client_version_num_d,\n    client_version = client_version_s,\n    client_extension = client_extension_s,\n    client_ec_point_format = client_ec_point_format_s,\n    client_curve_num = client_curve_num_s,\n    ja3 = ja3_g,\n    ja3s = ja3s_g,\n    server_extensions = server_extensions_s,\n\t//x509\n    certificate_version = certificate_version_d,\n    certificate_subject = certificate_subject_s,\n    certificate_issuer = certificate_issuer_s,\n    certificate_key_alg = certificate_key_alg_s,\n    certificate_key_length = certificate_key_length_s,\n    certificate_key_type = certificate_key_type_s,\n    certificate_not_valid_after = certificate_not_valid_after_d,\n    certificate_not_valid_before = certificate_not_valid_before_d,\n    certificate_exponent = certificate_exponent_s,\n    certificate_sig_alg = certificate_sig_alg_s,\n    certificate_self_issued = certificate_self_issued_b,\n    certificate_curve = certificate_curve_s,\n    certificate_cn = certificate_cn_s,\n    san_dns = san_dns_s,\n    san_email = san_email_s,\n    san_ip = san_ip_s,\n    san_other_fields = san_other_fields_b,\n    basic_constraints_ca = basic_constraints_ca_b,\n    basic_constraints_path_len = basic_constraints_path_len_d\n",
        "version": 1,
        "tags": []
      }
    }
  ]
}
